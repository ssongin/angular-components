name: PR Validation

on:
  pull_request:

jobs:
  validate-commit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Extract commit message
        id: commit
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%s)
          echo "message=$COMMIT_MSG" >> $GITHUB_OUTPUT

      - name: Validate commit prefix
        run: |
          COMMIT_MSG="${{ steps.commit.outputs.message }}"
          echo "Commit message: $COMMIT_MSG"

          shopt -s nocasematch

          if [[ "$COMMIT_MSG" =~ ^merge ]]; then
            echo "ℹ️ Merge commit — skipping validation"
            exit 0
          fi

          if [[ "$COMMIT_MSG" =~ ^(epic|major|feat|fix|build|chore|perf|refactor|revert|style|cicd|docs|test)(\([^)]+\))?: ]]; then
            echo "✅ Valid commit prefix"
          else
            echo "❌ Invalid commit prefix"
            exit 1
          fi

  build-docusaurus:
    runs-on: ubuntu-latest
    needs: validate-commit
    defaults:
      run:
        working-directory: ./docs
        
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm

      - run: npm ci
      - run: npm run build   

  build:
    runs-on: ubuntu-latest
    needs: validate-commit

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm

      - run: npm ci
      - run: npm run build

  storybook-build:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm

      - run: npm ci
      - run: npm run build-storybook

  test:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm

      - run: npm ci
      - run: npm run test -- --watch=false

  lint:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm

      - run: npm ci
      - run: npm run lint